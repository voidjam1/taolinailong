<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ESCAPE: NEON CITY</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00ff00; font-size: 20px; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>
    <div id="loading">正在照明 3D 世界...</div>
    <div id="ui"><div id="dist">距离追捕者: --m</div></div>

    <script type="importmap">
        { "imports": { 
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        // 稍微调远雾气，防止遮挡视线
        scene.fog = new THREE.Fog(0x050505, 50, 300);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        // 提高色调映射，让画面更亮
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 2.5; 
        document.body.appendChild(renderer.domElement);

        // --- 暴力打光系统 ---
        const ambient = new THREE.AmbientLight(0xffffff, 3.0); // 极强的全局光
        scene.add(ambient);

        const skyLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 2.0);
        scene.add(skyLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
        dirLight.position.set(100, 200, 100);
        scene.add(dirLight);

        // --- 地图加载 ---
        const fbxLoader = new FBXLoader();
        fbxLoader.load('map.fbx', (object) => {
            const box = new THREE.Box3().setFromObject(object);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const scale = 300 / Math.max(size.x, size.z);
            object.scale.set(scale, scale, scale);
            object.position.set(-center.x * scale, -box.min.y * scale, -center.z * scale);

            object.traverse((child) => {
                if (child.isMesh) {
                    // 强制覆盖材质属性，破除死黑
                    child.material = new THREE.MeshStandardMaterial({
                        color: child.material.color || 0xcccccc,
                        map: child.material.map,
                        metalness: 0.1, // 降低金属度，防止变黑
                        roughness: 0.5,
                        emissive: new THREE.Color(0x111111), // 淡淡的自发光
                    });
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            scene.add(object);
            document.getElementById('loading').style.display = 'none';
        });

        // --- 角色与追逐 ---
        const player = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: 0x00ff00, emissive: 0x00ff00}));
        player.position.set(0, 1, 0);
        scene.add(player);

        const chaser = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), new THREE.MeshStandardMaterial({color: 0xff0000, emissive: 0xff0000}));
        chaser.position.set(0, 2, 40);
        scene.add(chaser);

        const keys = {};
        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        function animate() {
            requestAnimationFrame(animate);
            if (keys['w']) player.position.z -= 0.5;
            if (keys['s']) player.position.z += 0.5;
            if (keys['a']) player.position.x -= 0.5;
            if (keys['d']) player.position.x += 0.5;

            // 追逐逻辑
            const dir = new THREE.Vector3().subVectors(player.position, chaser.position).normalize();
            chaser.position.add(dir.multiplyScalar(0.45));

            // 相机跟随
            camera.position.lerp(new THREE.Vector3(player.position.x, player.position.y + 8, player.position.z + 18), 0.1);
            camera.lookAt(player.position);

            const d = player.position.distanceTo(chaser.position);
            document.getElementById('dist').innerText = `距离追捕者: ${d.toFixed(1)}m`;

            if(d < 2) location.reload();

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
