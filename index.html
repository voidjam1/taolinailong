<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>é€ƒç¦»å¤§é¦™è•‰ 2.0 - Web 3Dç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Microsoft YaHei', sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; color: yellow; text-shadow: 2px 2px #000; pointer-events: none; }
        #overlay { 
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,0,0,0.4); color: white; flex-direction: column; align-items: center; justify-content: center;
        }
        button { padding: 10px 20px; font-size: 20px; cursor: pointer; background: yellow; border: none; font-weight: bold; }
    </style>
</head>
<body>
    <div id="ui">
        <h1>ğŸŒ é€ƒç¦»å¤§é¦™è•‰ (RUN!)</h1>
        <p>å®ƒæ˜¯é­”æ€§çš„ï¼Œå®ƒæ˜¯ç–¯ç‹‚çš„... åˆ«è®©å®ƒè¿½ä¸Šï¼</p>
    </div>
    <div id="overlay">
        <h2 id="msg">ä½ è¢«å¤§é¦™è•‰åƒæ‰äº†ï¼ğŸŒ</h2>
        <button onclick="location.reload()">é‡æ–°é€ƒäº¡</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // åŸºç¡€è®¾ç½®
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000); // é»‘è‰²èƒŒæ™¯æ›´æœ‰ææ€–æ„Ÿ
        scene.fog = new THREE.Fog(0x000000, 5, 40);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ç¯å…‰ï¼šåƒè§†é¢‘é‡Œé‚£æ ·æœ‰ä¸€ç‚¹é˜´æ£®çš„èšå…‰ç¯æ„Ÿ
        const spotLight = new THREE.SpotLight(0xffffff, 2);
        spotLight.position.set(0, 10, 0);
        scene.add(spotLight);
        scene.add(new THREE.AmbientLight(0x444444));

        // 1. ç©å®¶ (ç»¿è‰²æ–¹å—)
        const player = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({ color: 0x00ff00 }));
        player.position.y = 1;
        scene.add(player);

        // 2. â€œå¤§é¦™è•‰â€è¿½é€è€… (é»„è‰²æ‹‰é•¿çƒä½“)
        // TODO: æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ banana.glb ç´ æ
        const bananaGeo = new THREE.CapsuleGeometry(1.5, 4, 4, 16); 
        const bananaMat = new THREE.MeshStandardMaterial({ color: 0xffff00, emissive: 0x333300 });
        const chaser = new THREE.Mesh(bananaGeo, bananaMat);
        chaser.position.set(0, 3, 20); // åˆå§‹åœ¨åæ–¹
        scene.add(chaser);

        // 3. è·‘é“ (åƒè§†é¢‘é‡Œé‚£ç§é•¿å»Š)
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(10, 10000), new THREE.MeshStandardMaterial({ color: 0x222222 }));
        ground.rotation.x = -Math.PI/2;
        scene.add(ground);

        // 4. é€»è¾‘å˜é‡
        let speed = 0.25;
        let chaseSpeed = 0.23;
        const keys = {};
        let isOver = false;

        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        // 5. å¾ªç¯
        function animate() {
            if (isOver) return;
            requestAnimationFrame(animate);

            // ç©å®¶å‰è¿› (è‡ªåŠ¨å‘å‰è·‘ï¼Œå¢åŠ ç´§å¼ æ„Ÿ)
            player.position.z -= speed;
            if(keys['a']) player.position.x -= 0.15;
            if(keys['d']) player.position.x += 0.15;

            // å¤§é¦™è•‰è¿½é€
            const dir = new THREE.Vector3().subVectors(player.position, chaser.position).normalize();
            chaser.position.add(dir.multiplyScalar(chaseSpeed));
            
            // æ€ªç‰©æ‘‡æ‘†åŠ¨ç”» (æ¨¡æ‹Ÿè§†é¢‘é‡Œé‚£ç§é¬¼ç•œæ„Ÿ)
            chaser.rotation.z = Math.sin(Date.now() * 0.01) * 0.2;
            chaser.rotation.y += 0.05;

            // ç›¸æœºè·Ÿéš
            camera.position.set(player.position.x, player.position.y + 3, player.position.z + 8);
            camera.lookAt(player.position);
            spotLight.position.set(player.position.x, 10, player.position.z);

            // æ­»äº¡åˆ¤å®š
            if (player.position.distanceTo(chaser.position) < 2.5) {
                isOver = true;
                document.getElementById('overlay').style.display = 'flex';
            }

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
